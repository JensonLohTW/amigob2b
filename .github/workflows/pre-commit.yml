name: Pre-commit Checks

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check file sizes
      run: |
        echo "æª¢æŸ¥å¤§æ–‡ä»¶..."
        find . -type f -size +10M -not -path "./node_modules/*" -not -path "./.git/*" | while read file; do
          echo "è­¦å‘Š: ç™¼ç¾å¤§æ–‡ä»¶ $file ($(du -h "$file" | cut -f1))"
        done

    - name: Check for sensitive files
      run: |
        echo "æª¢æŸ¥æ•æ„Ÿæ–‡ä»¶..."
        sensitive_patterns=(
          "*.key"
          "*.pem"
          "*.p12"
          "*.pfx"
          ".env"
          ".env.local"
          ".env.production"
          "id_rsa"
          "id_dsa"
          "*.log"
        )
        
        for pattern in "${sensitive_patterns[@]}"; do
          if find . -name "$pattern" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
            echo "éŒ¯èª¤: ç™¼ç¾æ•æ„Ÿæ–‡ä»¶åŒ¹é…æ¨¡å¼ $pattern"
            find . -name "$pattern" -not -path "./node_modules/*" -not -path "./.git/*"
            exit 1
          fi
        done

    - name: Check for secrets in code
      run: |
        echo "æª¢æŸ¥ä»£ç¢¼ä¸­çš„ç§˜å¯†..."
        secret_patterns=(
          "password\s*=\s*['\"][^'\"]*['\"]"
          "api[_-]?key\s*=\s*['\"][^'\"]*['\"]"
          "secret\s*=\s*['\"][^'\"]*['\"]"
          "token\s*=\s*['\"][^'\"]*['\"]"
          "AKIA[0-9A-Z]{16}"
          "sk_live_[0-9a-zA-Z]{24}"
          "pk_live_[0-9a-zA-Z]{24}"
        )
        
        for pattern in "${secret_patterns[@]}"; do
          if grep -r -E "$pattern" src/ --exclude-dir=node_modules; then
            echo "è­¦å‘Š: å¯èƒ½ç™¼ç¾ç¡¬ç·¨ç¢¼çš„ç§˜å¯†"
          fi
        done

    - name: Lint code
      run: npm run lint

    - name: Type check
      run: npx tsc --noEmit

    - name: Check code formatting
      run: npx prettier --check .

    - name: Test build
      run: npm run build

    - name: Check bundle size
      run: |
        echo "æª¢æŸ¥æ‰“åŒ…å¤§å°..."
        if [ -d ".next" ]; then
          du -sh .next/static/chunks/*.js | sort -hr | head -10
        fi

    - name: Security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Check dependencies
      run: |
        echo "æª¢æŸ¥éŽæ™‚çš„ä¾è³´..."
        npx npm-check-updates --errorLevel 2
      continue-on-error: true

    - name: Validate package.json
      run: |
        echo "é©—è­‰ package.json..."
        node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"

    - name: Check for TODO comments
      run: |
        echo "æª¢æŸ¥ TODO è¨»é‡‹..."
        if grep -r "TODO\|FIXME\|HACK" src/ --exclude-dir=node_modules; then
          echo "ç™¼ç¾å¾…è¾¦äº‹é …è¨»é‡‹ï¼Œè«‹åœ¨æäº¤å‰è™•ç†"
        fi
      continue-on-error: true

    - name: Check commit message
      if: github.event_name == 'push'
      run: |
        echo "æª¢æŸ¥æäº¤è¨Šæ¯æ ¼å¼..."
        commit_msg=$(git log -1 --pretty=%B)
        if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+"; then
          echo "è­¦å‘Š: æäº¤è¨Šæ¯ä¸ç¬¦åˆ Conventional Commits æ ¼å¼"
          echo "ç•¶å‰è¨Šæ¯: $commit_msg"
          echo "å»ºè­°æ ¼å¼: type(scope): description"
        fi
      continue-on-error: true

    - name: Generate summary
      run: |
        echo "## ðŸŽ‰ Pre-commit æª¢æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… é€šéŽçš„æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "- ä»£ç¢¼æ ¼å¼æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "- TypeScript é¡žåž‹æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "- ESLint ä»£ç¢¼å“è³ªæª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "- æ§‹å»ºæ¸¬è©¦" >> $GITHUB_STEP_SUMMARY
        echo "- æ•æ„Ÿæ–‡ä»¶æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š é …ç›®çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- ç¸½æ–‡ä»¶æ•¸: $(find src/ -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- TypeScript æ–‡ä»¶: $(find src/ -name "*.ts" -o -name "*.tsx" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- çµ„ä»¶æ•¸é‡: $(find src/components/ -name "*.tsx" 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- é é¢æ•¸é‡: $(find src/app/ -name "page.tsx" 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
